@echo off
setlocal enabledelayedexpansion
chcp 65001 > nul

:main
cls
echo.
echo ========================================
echo           æœºå™¨ç‹—è®¾å¤‡æ£€æµ‹å™¨
echo ========================================
echo ä½¿ç”¨è¯´æ˜Žï¼š
echo 1. å…ˆè¿è¡Œä¸€æ¬¡ç¨‹åºï¼Œè®°å½•å½“å‰è®¾å¤‡åˆ—è¡¨
echo 2. æ’å…¥æ‚¨çš„æœºå™¨ç‹—è®¾å¤‡
echo 3. å†æ¬¡è¿è¡Œç¨‹åºï¼Œå¯¹æ¯”æ–°å¢žçš„è®¾å¤‡
echo 4. æ–°å¢žçš„è®¾å¤‡å°±æ˜¯æ‚¨çš„æœºå™¨ç‹—!
echo ========================================
echo.

echo å½“å‰æ£€æµ‹åˆ°çš„ä¸²å£è®¾å¤‡ï¼š
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.

REM ä½¿ç”¨wmicå‘½ä»¤æŸ¥è¯¢ä¸²å£è®¾å¤‡
set /a count=0
for /f "tokens=1,2 delims=," %%a in ('wmic path Win32_SerialPort get DeviceID^,Name /format:csv ^| findstr /v "Node"') do (
    if not "%%b"=="" (
        set /a count+=1
        echo ðŸ“± è®¾å¤‡ !count!: %%b ^-^> %%a

        REM ç®€å•çš„è®¾å¤‡ç±»åž‹è¯†åˆ«
        echo %%a | findstr /i "USB" >nul && echo    ðŸ’¡ è¿™æ˜¯ä¸€ä¸ªUSBä¸²å£è®¾å¤‡
        echo %%a | findstr /i "CH340\|CH341" >nul && echo    ðŸ’¡ æ£€æµ‹åˆ°CH340/CH341èŠ¯ç‰‡ ^(å¸¸ç”¨äºŽArduinoå…¼å®¹è®¾å¤‡^)
        echo %%a | findstr /i "FTDI" >nul && echo    ðŸ’¡ æ£€æµ‹åˆ°FTDIèŠ¯ç‰‡ ^(é«˜è´¨é‡USBè½¬ä¸²å£^)
        echo %%a | findstr /i "CP210" >nul && echo    ðŸ’¡ æ£€æµ‹åˆ°CP210xèŠ¯ç‰‡ ^(Silicon Labs USBè½¬ä¸²å£^)
        echo.
    )
)

REM å¦‚æžœwmicæ²¡æœ‰æ‰¾åˆ°è®¾å¤‡ï¼Œå°è¯•ä½¿ç”¨æ³¨å†Œè¡¨æ–¹æ³•
if %count%==0 (
    echo å°è¯•ä½¿ç”¨æ³¨å†Œè¡¨æ–¹æ³•æ£€æµ‹...
    echo.

    for /f "tokens=1,2*" %%a in ('reg query "HKLM\HARDWARE\DEVICEMAP\SERIALCOMM" 2^>nul') do (
        if not "%%c"=="" (
            set /a count+=1
            echo ðŸ“± è®¾å¤‡ !count!: %%a ^-^> %%c
            echo    ðŸ’¡ æ£€æµ‹åˆ°ä¸²å£è®¾å¤‡
            echo.
        )
    )
)

echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if %count%==0 (
    echo âŒ æœªæ£€æµ‹åˆ°ä»»ä½•ä¸²å£è®¾å¤‡
    echo.
    echo ðŸ’¡ è¯·æ£€æŸ¥ï¼š
    echo    - è®¾å¤‡æ˜¯å¦æ­£ç¡®è¿žæŽ¥åˆ°ç”µè„‘
    echo    - è®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯å¦å·²å®‰è£…
    echo    - USBçº¿ç¼†æ˜¯å¦æ­£å¸¸å·¥ä½œ
) else (
    echo âœ… æ€»å…±æ£€æµ‹åˆ° %count% ä¸ªä¸²å£è®¾å¤‡
)

echo.
echo é€‰æ‹©æ“ä½œï¼š
echo 1. ðŸ” é‡æ–°æ‰«æè®¾å¤‡
echo 2. ðŸ“‹ æµ‹è¯•ç‰¹å®šCOMå£
echo 3. ðŸ“– æŸ¥çœ‹ä½¿ç”¨è¯´æ˜Ž
echo 4. âŒ é€€å‡ºç¨‹åº
echo.
set /p choice="è¯·è¾“å…¥é€‰é¡¹ (1-4): "

if "%choice%"=="1" (
    echo.
    echo ðŸ”„ æ­£åœ¨é‡æ–°æ‰«æè®¾å¤‡...
    timeout /t 1 >nul
    goto main
)

if "%choice%"=="2" (
    echo.
    set /p portname="è¯·è¾“å…¥è¦æµ‹è¯•çš„COMå£åç§° (ä¾‹å¦‚: COM3): "
    if not "!portname!"=="" (
        echo æµ‹è¯• !portname! çš„è¿žæŽ¥æ€§...
        REM å°è¯•ä½¿ç”¨modeå‘½ä»¤æµ‹è¯•ç«¯å£
        mode !portname! baud=9600 parity=n data=8 stop=1 >nul 2>&1
        if !errorlevel! equ 0 (
            echo âœ… !portname! å¯ä»¥æ­£å¸¸è®¿é—®
        ) else (
            echo âŒ !portname! æ— æ³•è®¿é—® ^(å¯èƒ½è¢«å…¶ä»–ç¨‹åºå ç”¨^)
        )
        echo.
        pause
    )
    goto main
)

if "%choice%"=="3" (
    cls
    echo ========================================
    echo           è¯¦ç»†ä½¿ç”¨è¯´æ˜Ž
    echo ========================================
    echo.
    echo ðŸŽ¯ ç›®æ ‡ï¼šæ‰¾åˆ°æ‚¨çš„æœºå™¨ç‹—è®¾å¤‡åç§°
    echo.
    echo ðŸ“ æ“ä½œæ­¥éª¤ï¼š
    echo 1ï¸âƒ£  é¦–å…ˆæ‹”æŽ‰æœºå™¨ç‹—è®¾å¤‡
    echo 2ï¸âƒ£  è¿è¡Œæ­¤ç¨‹åºï¼Œè®°å½•å½“å‰çš„è®¾å¤‡åˆ—è¡¨
    echo 3ï¸âƒ£  æ’å…¥æœºå™¨ç‹—è®¾å¤‡å¹¶ç­‰å¾…ç³»ç»Ÿè¯†åˆ«
    echo 4ï¸âƒ£  å†æ¬¡æ‰«æè®¾å¤‡ï¼Œæ–°å‡ºçŽ°çš„å°±æ˜¯æ‚¨çš„æœºå™¨ç‹—
    echo.
    echo ðŸ” è®¾å¤‡è¯†åˆ«æç¤ºï¼š
    echo â€¢ æœºå™¨ç‹—é€šå¸¸æ˜¾ç¤ºä¸º COM1, COM3, COM4 ç­‰
    echo â€¢ è®¾å¤‡åå¯èƒ½åŒ…å« USB, CH340, FTDI ç­‰å…³é”®è¯
    echo â€¢ å¦‚æžœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œå¯ä»¥é€ä¸ªæµ‹è¯•
    echo.
    echo âš ï¸  æ³¨æ„äº‹é¡¹ï¼š
    echo â€¢ ç¡®ä¿æœºå™¨ç‹—è®¾å¤‡å·²æ­£ç¡®å®‰è£…é©±åŠ¨
    echo â€¢ å¦‚æžœè®¾å¤‡æ— æ³•è®¿é—®ï¼Œå¯èƒ½è¢«å…¶ä»–ç¨‹åºå ç”¨
    echo â€¢ æŸäº›è®¾å¤‡å¯èƒ½éœ€è¦ç‰¹å®šçš„æ³¢ç‰¹çŽ‡è®¾ç½®
    echo.
    pause
    goto main
)

if "%choice%"=="4" (
    echo.
    echo ðŸ‘‹ æ„Ÿè°¢ä½¿ç”¨æœºå™¨ç‹—è®¾å¤‡æ£€æµ‹å™¨ï¼
    goto end
)

echo âŒ æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©
timeout /t 2 >nul
goto main

:end
pause
